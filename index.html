<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DID Key Recovery Specification (DID-KR) · Sirraya Labs</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Lato:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --ink:        #0e1117;
            --ink-light:  #3d4450;
            --ink-muted:  #6b7585;
            --rule:       #dde1e9;
            --rule-light: #eef0f5;
            --bg:         #f5f6f8;
            --paper:      #ffffff;
            --accent:     #1a56db;
            --accent-2:   #0e3fa0;
            --accent-bg:  #eef3fd;
            --warn:       #b45309;
            --warn-bg:    #fef3c7;
            --fixed:      #059669;
            --fixed-bg:   #d1fae5;
            --removed:    #dc2626;
            --removed-bg: #fee2e2;
            --mono:       'DM Mono', monospace;
            --serif:      'DM Serif Display', Georgia, serif;
            --sans:       'Lato', system-ui, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { scroll-behavior: smooth; }

        body {
            font-family: var(--sans);
            font-weight: 300;
            font-size: 16px;
            line-height: 1.75;
            color: var(--ink);
            background: var(--bg);
        }

        /* ── Layout ── */
        .page-wrap {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        /* ── Sidebar TOC ── */
        .sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            background: var(--ink);
            color: #c9cdd8;
            padding: 2rem 0;
            font-size: 0.82rem;
        }

        .sidebar-logo {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 1.5rem;
        }

        .sidebar-logo .org {
            font-family: var(--mono);
            font-size: 0.7rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: #7b8499;
            margin-bottom: 0.35rem;
        }

        .sidebar-logo .spec-name {
            font-family: var(--serif);
            font-size: 1.1rem;
            color: #fff;
            line-height: 1.3;
        }

        .sidebar-logo .version-badge {
            display: inline-block;
            margin-top: 0.5rem;
            background: var(--accent);
            color: #fff;
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            padding: 0.2em 0.6em;
            border-radius: 3px;
        }

        .toc-section {
            padding: 0 1.5rem;
            margin-bottom: 1.5rem;
        }

        .toc-section-label {
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: #586070;
            margin-bottom: 0.5rem;
        }

        .toc-list { list-style: none; }
        .toc-list li { line-height: 1.4; }

        .toc-list a {
            display: block;
            color: #a0a8bc;
            text-decoration: none;
            padding: 0.22rem 0;
            border-left: 2px solid transparent;
            padding-left: 0.75rem;
            margin-left: -0.75rem;
            transition: color 0.15s, border-color 0.15s;
        }

        .toc-list a:hover,
        .toc-list a.active {
            color: #fff;
            border-left-color: var(--accent);
        }

        .toc-list .sub {
            padding-left: 1rem;
            font-size: 0.78rem;
        }

        /* ── Main content ── */
        .main {
            background: var(--paper);
            padding: 4rem 5rem 6rem;
            max-width: 900px;
        }

        /* ── Header ── */
        .spec-header {
            padding-bottom: 3rem;
            border-bottom: 2px solid var(--rule);
            margin-bottom: 3.5rem;
        }

        .org-tag {
            font-family: var(--mono);
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .org-tag::before {
            content: '';
            display: inline-block;
            width: 24px;
            height: 2px;
            background: var(--accent);
        }

        .spec-header h1 {
            font-family: var(--serif);
            font-size: 3rem;
            line-height: 1.15;
            color: var(--ink);
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
        }

        .spec-header .tagline {
            font-size: 1.1rem;
            color: var(--ink-light);
            font-weight: 300;
            margin-bottom: 2rem;
        }

        /* Change log banner */
        .changelog-banner {
            background: var(--fixed-bg);
            border: 1px solid #6ee7b7;
            border-radius: 8px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 2rem;
        }

        .changelog-banner .banner-title {
            font-family: var(--mono);
            font-size: 0.72rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--fixed);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .changelog-banner ul {
            margin: 0;
            padding-left: 1.25rem;
            font-size: 0.9rem;
            color: #065f46;
        }

        .changelog-banner li { margin-bottom: 0.2rem; }

        .meta-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
            border: 1px solid var(--rule);
            border-radius: 8px;
            overflow: hidden;
        }

        .meta-cell {
            padding: 1rem 1.25rem;
            border-right: 1px solid var(--rule);
        }

        .meta-cell:last-child { border-right: none; }

        .meta-cell .label {
            font-family: var(--mono);
            font-size: 0.65rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--ink-muted);
            margin-bottom: 0.3rem;
        }

        .meta-cell .value {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--ink);
        }

        .meta-cell .value a { color: var(--accent); text-decoration: none; }

        /* ── Section headings ── */
        h2 {
            font-family: var(--serif);
            font-size: 1.9rem;
            color: var(--ink);
            margin: 3.5rem 0 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--rule);
            letter-spacing: -0.01em;
            line-height: 1.2;
        }

        h3 {
            font-family: var(--serif);
            font-size: 1.35rem;
            color: var(--ink);
            margin: 2.25rem 0 0.85rem;
            font-style: italic;
        }

        h4 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--ink);
            margin: 1.75rem 0 0.6rem;
            letter-spacing: 0.01em;
        }

        p { margin-bottom: 1.1rem; color: var(--ink-light); }

        ul, ol {
            margin: 0.75rem 0 1.25rem 1.5rem;
            color: var(--ink-light);
        }

        li { margin-bottom: 0.4rem; }

        a { color: var(--accent); }

        strong { color: var(--ink); font-weight: 700; }

        /* ── Code ── */
        pre {
            background: #0d1117;
            color: #c9d1d9;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: var(--mono);
            font-size: 0.83rem;
            line-height: 1.6;
            margin: 1.25rem 0 1.75rem;
            border: 1px solid #21262d;
        }

        code {
            font-family: var(--mono);
            font-size: 0.85em;
            background: var(--rule-light);
            color: var(--ink);
            padding: 0.15em 0.45em;
            border-radius: 3px;
            border: 1px solid var(--rule);
        }

        pre code {
            background: transparent;
            color: inherit;
            padding: 0;
            border: none;
            font-size: inherit;
        }

        /* ── Callouts ── */
        .callout {
            border-radius: 8px;
            padding: 1.25rem 1.5rem;
            margin: 1.5rem 0;
            font-size: 0.93rem;
        }

        .callout-label {
            font-family: var(--mono);
            font-size: 0.68rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 0.4rem;
        }

        .callout.note    { background: var(--accent-bg);  border-left: 3px solid var(--accent);  }
        .callout.note .callout-label    { color: var(--accent-2); }
        .callout.warning { background: var(--warn-bg);    border-left: 3px solid var(--warn);    }
        .callout.warning .callout-label { color: var(--warn); }
        .callout.fixed   { background: var(--fixed-bg);   border-left: 3px solid var(--fixed);   }
        .callout.fixed .callout-label   { color: var(--fixed); }
        .callout.removed { background: var(--removed-bg); border-left: 3px solid var(--removed); }
        .callout.removed .callout-label { color: var(--removed); }
        .callout p { color: inherit; margin: 0; }

        /* ── Math / algorithm blocks ── */
        .math-block {
            background: var(--rule-light);
            border: 1px solid var(--rule);
            border-radius: 8px;
            padding: 1.25rem 1.5rem;
            font-family: var(--mono);
            font-size: 0.85rem;
            line-height: 1.8;
            margin: 1.25rem 0 1.75rem;
            color: var(--ink);
        }

        .math-block .math-comment {
            color: var(--ink-muted);
            font-style: italic;
        }

        /* ── Diagram containers ── */
        .diagram-container {
            border: 1px solid var(--rule);
            border-radius: 10px;
            padding: 1.75rem;
            margin: 1.75rem 0;
            background: #fafbfc;
        }

        .diagram-title {
            font-family: var(--mono);
            font-size: 0.72rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--ink-muted);
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--rule);
        }

        .mermaid { background: transparent; text-align: center; }

        /* ── Tables ── */
        .table-wrap { overflow-x: auto; margin: 1.5rem 0 2rem; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        thead th {
            background: var(--ink);
            color: #fff;
            font-weight: 700;
            font-size: 0.78rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            padding: 0.75rem 1rem;
            text-align: left;
        }

        tbody td {
            padding: 0.7rem 1rem;
            border-bottom: 1px solid var(--rule-light);
            color: var(--ink-light);
            vertical-align: top;
        }

        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background: var(--rule-light); }

        .badge {
            display: inline-block;
            font-family: var(--mono);
            font-size: 0.7rem;
            padding: 0.2em 0.6em;
            border-radius: 3px;
            font-weight: 500;
        }

        .badge-done { background: var(--fixed-bg); color: var(--fixed); }
        .badge-todo { background: var(--rule-light); color: var(--ink-muted); }
        .badge-changed { background: var(--accent-bg); color: var(--accent-2); }

        /* ── DL terms ── */
        dt {
            font-weight: 700;
            color: var(--ink);
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        dd {
            margin-left: 1.5rem;
            margin-bottom: 0.25rem;
            color: var(--ink-light);
        }

        /* ── Param table ── */
        .param-box {
            background: var(--rule-light);
            border: 1px solid var(--rule);
            border-radius: 8px;
            padding: 1.25rem 1.5rem;
            font-family: var(--mono);
            font-size: 0.82rem;
            line-height: 1.9;
            margin: 1.25rem 0 1.75rem;
        }

        .param-box .param-row {
            display: flex;
            gap: 1rem;
        }

        .param-box .param-key {
            color: var(--accent);
            min-width: 60px;
            font-weight: 500;
        }

        .param-box .param-val { color: var(--ink); }

        /* ── Diff tags ── */
        .tag-new {
            display: inline-block;
            font-family: var(--mono);
            font-size: 0.6rem;
            background: var(--fixed-bg);
            color: var(--fixed);
            border: 1px solid #6ee7b7;
            border-radius: 3px;
            padding: 0.1em 0.45em;
            vertical-align: middle;
            letter-spacing: 0.05em;
            margin-left: 0.4rem;
        }

        .tag-changed {
            display: inline-block;
            font-family: var(--mono);
            font-size: 0.6rem;
            background: var(--accent-bg);
            color: var(--accent-2);
            border: 1px solid #93c5fd;
            border-radius: 3px;
            padding: 0.1em 0.45em;
            vertical-align: middle;
            letter-spacing: 0.05em;
            margin-left: 0.4rem;
        }

        /* ── Footer ── */
        .spec-footer {
            margin-top: 5rem;
            padding-top: 2rem;
            border-top: 2px solid var(--rule);
            font-size: 0.85rem;
            color: var(--ink-muted);
        }

        .spec-footer a { color: var(--accent); }

        /* ── Responsive ── */
        @media (max-width: 900px) {
            .page-wrap { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .main { padding: 2rem 1.5rem 4rem; max-width: 100%; }
            .meta-grid { grid-template-columns: repeat(2, 1fr); }
            .spec-header h1 { font-size: 2.2rem; }
        }
    </style>
</head>
<body>
<div class="page-wrap">

    <!-- ════════════════ SIDEBAR ════════════════ -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <div class="org">Sirraya Labs</div>
            <div class="spec-name">DID Key Recovery<br>Specification</div>
            <span class="version-badge">v1.0.0-draft · rev 2.1</span>
        </div>

        <div class="toc-section">
            <div class="toc-section-label">Preamble</div>
            <ul class="toc-list">
                <li><a href="#abstract">Abstract</a></li>
                <li><a href="#sotd">Status of Document</a></li>
                <li><a href="#introduction">1. Introduction</a></li>
                <li class="sub"><a href="#design-goals">1.1 Design Goals</a></li>
                <li class="sub"><a href="#relationship">1.2 Relationship to DID Core</a></li>
                <li><a href="#conformance">2. Conformance</a></li>
                <li><a href="#terminology">3. Terminology</a></li>
            </ul>
        </div>

        <div class="toc-section">
            <div class="toc-section-label">Architecture</div>
            <ul class="toc-list">
                <li><a href="#architecture">4. Architecture</a></li>
                <li><a href="#recovery-method-types">5. Recovery Methods</a></li>
                <li class="sub"><a href="#type-a">5.1 Type A: Social ZKP</a></li>
                <li class="sub"><a href="#type-b">5.2 Type B: Deterministic</a></li>
                <li class="sub"><a href="#type-c">5.3 Type C: MPC-Mediated</a></li>
                <li class="sub"><a href="#provider-sync">5.4 Provider Sync</a></li>
                <li><a href="#verification-relationships">6. Verification Relationships</a></li>
            </ul>
        </div>

        <div class="toc-section">
            <div class="toc-section-label">Cryptography</div>
            <ul class="toc-list">
                <li><a href="#crypto-primitives">7. Crypto Primitives</a></li>
                <li class="sub"><a href="#vss-group">7.0 VSS Group Parameters</a></li>
                <li class="sub"><a href="#feldman-vss">7.1 Feldman's VSS</a></li>
                <li class="sub"><a href="#zkp">7.2 ZKP of Share</a></li>
                <li class="sub"><a href="#vdf">7.3 VDF</a></li>
                <li class="sub"><a href="#frost">7.5 fROST</a></li>
            </ul>
        </div>

        <div class="toc-section">
            <div class="toc-section-label">Compliance</div>
            <ul class="toc-list">
                <li><a href="#security-considerations">8. Security</a></li>
                <li><a href="#privacy-considerations">9. Privacy</a></li>
                <li><a href="#interoperability">10. Interoperability</a></li>
                <li><a href="#json-ld-context">11. JSON-LD Context</a></li>
                <li><a href="#protocol-flows">12. Protocol Flows</a></li>
                <li><a href="#test-vectors">13. Test Vectors</a></li>
                <li><a href="#references">14. References</a></li>
                <li><a href="#acknowledgements">15. Acknowledgements</a></li>
                <li><a href="#appendices">Appendices</a></li>
            </ul>
        </div>
    </aside>

    <!-- ════════════════ MAIN ════════════════ -->
    <main class="main">

        <!-- ── Header ── -->
        <div class="spec-header">
            <div class="org-tag">Sirraya Labs · Editor's Draft</div>
            <h1>DID Key Recovery (DID-KR)</h1>
            <p class="tagline">Decentralized Identifier Key Recovery Extension</p>

            <div class="changelog-banner">
                <div class="banner-title">Revision 2.1 — VSS Implementation Corrected</div>
                <ul>
                    <li><strong>§7.0 (new):</strong> Defines correct VSS group parameters — 256-bit safe prime <em>p = 2q+1</em> replacing broken secp256k1 reuse.</li>
                    <li><strong>§7.1 (updated):</strong> Feldman VSS now uses separate scalar field <em>Z<sub>q</sub></em> and group <em>Z<sub>p</sub>*</em> with <em>ord(g) = q</em>. Verification equation corrected.</li>
                    <li><strong>§13 (updated):</strong> Test vectors updated to use correct field and produce verifiable shares at all indices.</li>
                    <li><strong>Appendix A (updated):</strong> VSS implementation marked ✓ (complete); ZKP and others remain open.</li>
                </ul>
            </div>

            <div class="meta-grid">
                <div class="meta-cell">
                    <div class="label">Editor</div>
                    <div class="value">Amir Hameed Mir</div>
                </div>
                <div class="meta-cell">
                    <div class="label">Organization</div>
                    <div class="value">Sirraya Labs</div>
                </div>
                <div class="meta-cell">
                    <div class="label">Version</div>
                    <div class="value">1.0.0-draft rev 2.1</div>
                </div>
                <div class="meta-cell">
                    <div class="label">Repository</div>
                    <div class="value"><a href="https://github.com/sirraya-labs/did-kr">github.com/sirraya-labs/did-kr</a></div>
                </div>
            </div>
        </div>

        <!-- ── Abstract ── -->
        <section id="abstract">
            <h2>Abstract</h2>
            <p>This specification defines a standardized, interoperable mechanism for recovering control of Decentralized Identifiers (DIDs) when private keys are lost or compromised. It introduces three complementary recovery types — Social ZKP Recovery, Deterministic Seedling Inheritance, and MPC-based Mediated Recovery — each addressing different trust models and user personas.</p>
            <p>The specification includes cryptographic hardening through mathematically correct Verifiable Secret Sharing (Feldman VSS over a proper prime-order group), Verifiable Delay Functions, Proactive Secret Refreshment, and comprehensive security considerations with a formal JSON-LD context for machine interoperability.</p>
        </section>

        <!-- ── Status ── -->
        <section id="sotd">
            <h2>Status of This Document</h2>
            <p>This is an Editor's Draft prepared by Amir Hameed Mir of Sirraya Labs. Revision 2.1 corrects a critical mathematical error in the Feldman VSS specification and corresponding implementation (see §7.0 and §7.1). Comments and contributions are welcome via the GitHub repository.</p>
        </section>

        <!-- ── Introduction ── -->
        <section id="introduction">
            <h2>1. Introduction</h2>
            <p>The Decentralized Identifier (DID) architecture provides the foundation for self-sovereign identity but deliberately omits key recovery mechanisms, leaving implementers to develop ad-hoc, non-interoperable solutions. This gap represents a critical barrier to mass adoption, as users face permanent loss of identity or vendor lock-in when keys are lost.</p>
            <p>The DID Key Recovery Extension (DID-KR) addresses this gap by defining standardized recovery methods that can be published in DID Documents, discovered by resolvers, and executed through interoperable protocols. The specification embraces a "three-way solution" recognizing that no single recovery model suits all use cases:</p>
            <ul>
                <li><strong>Type A (Social ZKP Recovery):</strong> For users prioritizing autonomy, using threshold cryptography with zero-knowledge proofs to prevent guardian collusion.</li>
                <li><strong>Type B (Deterministic Seedling):</strong> For inheritance and migration, using hierarchical deterministic keys with Verifiable Delay Functions for decentralized time-locks.</li>
                <li><strong>Type C (MPC-Mediated):</strong> For enterprise and convenience users, using multi-party computation with threshold signatures and proactive share refreshment.</li>
            </ul>

            <h3 id="design-goals">1.1 Design Goals</h3>
            <ul>
                <li><strong>Non-Custodial:</strong> No single entity ever possesses the full private key.</li>
                <li><strong>Interoperable:</strong> Recovery methods are discoverable and executable across different wallet implementations.</li>
                <li><strong>Privacy-Preserving:</strong> Recovery metadata minimizes leakage of social graphs and security posture.</li>
                <li><strong>Mathematically Sound:</strong> All cryptographic constructions use correctly parameterized groups with proven security properties.</li>
                <li><strong>Future-Proof:</strong> Cryptographic agility allows migration to quantum-resistant algorithms.</li>
            </ul>

            <h3 id="relationship">1.2 Relationship to DID Core</h3>
            <p>This specification extends DID Core by defining:</p>
            <ol>
                <li>A new <code>recovery</code> verification relationship.</li>
                <li>Three new verification method types for recovery.</li>
                <li>Service endpoint definitions for recovery protocols.</li>
                <li>A JSON-LD context for machine-readable discovery.</li>
            </ol>
        </section>

        <!-- ── Conformance ── -->
        <section id="conformance">
            <h2>2. Conformance</h2>
            <p>As well as sections marked as non-normative, all authoring guidelines, diagrams, examples, and notes in this specification are non-normative. Everything else in this specification is normative.</p>
            <p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in BCP 14 [RFC2119] [RFC8174] when, and only when, they appear in all capitals, as shown here.</p>
        </section>

        <!-- ── Terminology ── -->
        <section id="terminology">
            <h2>3. Terminology</h2>
            <dl>
                <dt>DID Controller</dt>
                <dd>The entity authorized to make changes to a DID Document.</dd>
                <dt>Recovery Method</dt>
                <dd>A verification method specifically designated for recovering control of a DID.</dd>
                <dt>Guardian</dt>
                <dd>An entity holding a share of a recovery secret in Type A schemes.</dd>
                <dt>Beneficiary</dt>
                <dd>An entity authorized to inherit a DID in Type B schemes.</dd>
                <dt>Provider</dt>
                <dd>An MPC node participating in threshold signature generation for Type C schemes.</dd>
                <dt>Threshold (t)</dt>
                <dd>The minimum number of shares/participants required to complete recovery.</dd>
                <dt>Scalar Field Z<sub>q</sub></dt>
                <dd>A prime field of order q used for polynomial arithmetic in VSS. All share values and polynomial coefficients live in Z<sub>q</sub>.</dd>
                <dt>Commitment Group Z<sub>p</sub>*</dt>
                <dd>The multiplicative group modulo a prime p used for Feldman commitments. Distinct from the scalar field; chosen so that q divides (p−1).</dd>
                <dt>Safe Prime</dt>
                <dd>A prime p such that p = 2q+1 and q is also prime. Used to guarantee a subgroup of prime order q in Z<sub>p</sub>*.</dd>
                <dt>Share Refreshment</dt>
                <dd>The process of generating new secret shares without changing the secret or the public commitments, achieved by adding shares of a zero-secret refresh polynomial.</dd>
                <dt>Verifiable Delay Function (VDF)</dt>
                <dd>A function requiring a specific amount of sequential computation to evaluate.</dd>
                <dt>Epoch</dt>
                <dd>A version identifier for MPC provider share sets, incremented with each refreshment.</dd>
                <dt>Catch-up Protocol</dt>
                <dd>A mechanism for synchronizing lagging MPC providers to the current epoch.</dd>
            </dl>
        </section>

        <!-- ── Architecture ── -->
        <section id="architecture">
            <h2>4. The Recovery Method Architecture</h2>
            <p>The DID-KR architecture introduces a new verification relationship <code>recovery</code> in the DID Document. This relationship contains one or more recovery methods that define how a DID can be recovered.</p>

            <h3>4.1 Discovery Model</h3>
            <p>Recovery methods are discovered through standard DID resolution. A resolver or wallet implementing DID-KR:</p>
            <ol>
                <li>Resolves the DID Document.</li>
                <li>Checks for the <code>@context</code> including the DID-KR context.</li>
                <li>Extracts the <code>recovery</code> verification relationship.</li>
                <li>Parses the recovery methods according to their <code>type</code>.</li>
            </ol>

            <h3>4.2 Lifecycle</h3>
            <ol>
                <li><strong>Setup:</strong> The DID Controller generates recovery parameters and publishes them in the DID Document.</li>
                <li><strong>Execution:</strong> When recovery is needed, the recovering party initiates the protocol defined by the recovery method.</li>
                <li><strong>Completion:</strong> Upon successful recovery, the DID Document is updated with new verification methods, and the recovery methods may be rotated.</li>
                <li><strong>Revocation:</strong> Recovery methods can be revoked by the current controller using an active verification method.</li>
            </ol>
        </section>

        <!-- ── Recovery Method Types ── -->
        <section id="recovery-method-types">
            <h2>5. Recovery Method Types</h2>

            <!-- Type A -->
            <section id="type-a">
                <h3>5.1 Type A: Social ZKP Recovery</h3>
                <p><strong>Type URI:</strong> <code>RecoveryMethodZKPSocial</code></p>
                <p>The Social ZKP Recovery mechanism enables recovery through a threshold of trusted guardians without revealing secret shares to any party, including the guardians themselves.</p>

                <h4>5.1.1 Cryptographic Requirements</h4>
                <p>Implementations MUST use:</p>
                <ul>
                    <li><strong>Verifiable Secret Sharing (VSS):</strong> Feldman's VSS as specified in §7.1, using the group parameters defined in §7.0.</li>
                    <li><strong>Zero-Knowledge Proofs:</strong> Schnorr proofs of share consistency as specified in §7.2.</li>
                    <li><strong>Group:</strong> The 256-bit safe-prime group (p, q, g) defined in §7.0.</li>
                </ul>

                <h4>5.1.2 Setup Phase</h4>
                <ol>
                    <li>Generates a random secret <code>s ∈ Z<sub>q</sub></code> (the recovery key).</li>
                    <li>Constructs a random polynomial <code>P(x)</code> of degree <code>t−1</code> over <code>Z<sub>q</sub></code> where <code>P(0) = s</code>.</li>
                    <li>Computes shares <code>s<sub>i</sub> = P(i) mod q</code> for each of <code>n</code> guardians.</li>
                    <li>Computes Feldman commitments <code>C<sub>j</sub> = g<sup>a<sub>j</sub></sup> mod p</code> for each coefficient <code>a<sub>j</sub></code>.</li>
                    <li>Distributes to each guardian their encrypted share <code>s<sub>i</sub></code>, the commitments <code>C<sub>j</sub></code>, and a nonce for ZKP challenges.</li>
                    <li>Publishes commitments, guardian identifiers/endpoints, and threshold <code>t</code> in the DID Document.</li>
                </ol>

                <h4>5.1.3 Recovery Phase</h4>
                <ol>
                    <li>Recovering party contacts <code>t</code> guardians.</li>
                    <li>Each guardian generates a Schnorr ZKP (§7.2) proving knowledge of share <code>s<sub>i</sub></code> consistent with commitments <code>C<sub>j</sub></code>, without revealing <code>s<sub>i</sub></code>.</li>
                    <li>ZKPs are verified and shares are reconstructed using Lagrange interpolation in <code>Z<sub>q</sub></code>.</li>
                    <li>The reconstructed secret <code>s</code> is used to generate new DID keys.</li>
                </ol>

                <h4>5.1.4 DID Document Representation</h4>
                <pre><code class="language-json">{
  "id": "did:example:123#recovery-social",
  "type": "RecoveryMethodZKPSocial",
  "controller": "did:example:123",
  "recoveryThreshold": 3,
  "vssScheme": "feldman-safe-prime-256-2025",
  "vssGroupParameters": {
    "p": "0x50179e4375e428b3af8fe52af1f2a50e5100b916d0d1c1bbedc304c3d35f3217",
    "q": "0x280bcf21baf21459d7c7f29578f9528728805c8b6868e0ddf6e18261e9af990b",
    "g": "4"
  },
  "vssCommitments": [
    "0x2a3f...",
    "0x7c91..."
  ],
  "recoveryGuardians": [
    {
      "id": "did:guardian:abc#key-1",
      "guardianEndpoint": "https://guardian1.example.com/recover",
      "guardianType": "person",
      "commitmentIndex": 0
    }
  ],
  "curve": "safe-prime-256"
}</code></pre>

                <div class="diagram-container">
                    <div class="diagram-title">Figure 1 — Type A: Social ZKP Recovery Flow</div>
                    <div class="mermaid">
sequenceDiagram
    participant User as User (Recovering Party)
    participant G1 as Guardian 1
    participant G2 as Guardian 2
    participant G3 as Guardian 3
    participant Aggregator as ZKP Aggregator

    Note over User: Initiates recovery (threshold=3)

    User->>G1: Request recovery (nonce, commitments)
    User->>G2: Request recovery (nonce, commitments)
    User->>G3: Request recovery (nonce, commitments)

    G1->>G1: Generate Schnorr ZKP
    G2->>G2: Generate Schnorr ZKP
    G3->>G3: Generate Schnorr ZKP

    G1-->>User: ZKP Proof 1
    G2-->>User: ZKP Proof 2
    G3-->>User: ZKP Proof 3

    User->>Aggregator: Submit proofs (threshold=3)
    Aggregator->>Aggregator: Verify ZKPs against C_j
    Aggregator->>Aggregator: Lagrange interpolation in Z_q

    Aggregator-->>User: Recovered secret s
    User->>User: Generate new DID keys
    User->>DID Method: Update DID Document
                    </div>
                </div>
            </section>

            <!-- Type B -->
            <section id="type-b">
                <h3>5.2 Type B: Deterministic Seedling Inheritance</h3>
                <p><strong>Type URI:</strong> <code>RecoveryMethodDeterministic</code></p>
                <p>The Deterministic Seedling mechanism enables recovery through a master seed phrase, with optional time-locked inheritance for beneficiaries.</p>

                <h4>5.2.1 Cryptographic Requirements</h4>
                <ul>
                    <li><strong>Hierarchical Deterministic Keys:</strong> BIP-32 or BIP-39 style derivation.</li>
                    <li><strong>Encryption:</strong> XChaCha20-Poly1305 for seed lockbox.</li>
                    <li><strong>Time-Locks:</strong> Verifiable Delay Functions (VDFs) for decentralized inheritance.</li>
                    <li><strong>VDF Algorithm:</strong> Wesolowski's VDF or Pietrzak's VDF.</li>
                </ul>

                <h4>5.2.2 Setup Phase</h4>
                <ol>
                    <li>Generates a master seed <code>S</code> (128–256 bits of entropy).</li>
                    <li>Derives the DID private key using a standardized derivation path.</li>
                    <li>If inheritance desired: generates VDF parameters, computes <code>y = x<sup>2<sup>T</sup></sup> mod N</code>, and uses <code>y</code> to derive the seed lockbox encryption key.</li>
                    <li>Encrypts seed <code>S</code> to beneficiary's public key.</li>
                    <li>Publishes derivation path, encrypted lockbox, and VDF parameters in DID Document.</li>
                </ol>

                <h4>5.2.3 DID Document Representation</h4>
                <pre><code class="language-json">{
  "id": "did:example:123#recovery-seedling",
  "type": "RecoveryMethodDeterministic",
  "controller": "did:example:123",
  "seedDerivationPath": "m/44'/0'/0'/0/0",
  "derivationStandard": "bip32-ed25519",
  "encryptedSeedLockbox": {
    "ciphertext": "0x7b3a...f9c2",
    "algorithm": "XChaCha20-Poly1305",
    "iv": "0x1a2b...3c4d",
    "beneficiaryPublicKey": "did:beneficiary:abc#key-1",
    "beneficiaryKeyType": "x25519"
  },
  "deadMansSwitch": {
    "type": "VDFTimeLock",
    "vdfParameters": {
      "difficulty": 1000000,
      "estimatedWallTime": "P30D",
      "referencePlatform": "intel-i9-13900k-2024",
      "tolerance": 0.2,
      "modulus": "0x8f3b...a1c4",
      "challenge": "0x2d4e...f8a1",
      "vdfAlgorithm": "wesolowski-2024"
    },
    "inactivityPeriod": "P1Y"
  }
}</code></pre>

                <div class="diagram-container">
                    <div class="diagram-title">Figure 2 — Type B: VDF Time-Locked Inheritance</div>
                    <div class="mermaid">
sequenceDiagram
    participant User as Original User
    participant Beneficiary as Beneficiary
    participant VDF as VDF Computation
    participant DID as DID Method

    Note over User: Setup Phase
    User->>User: Generate master seed
    User->>User: Encrypt seed with VDF-derived key
    User->>DID: Publish encrypted lockbox + VDF params

    Note over User: User becomes inactive

    Beneficiary->>VDF: Compute VDF (difficulty=1M)
    VDF->>VDF: Sequential squaring (~30 days)
    VDF-->>Beneficiary: VDF output + Wesolowski proof

    Beneficiary->>Beneficiary: Derive decryption key from VDF output
    Beneficiary->>Beneficiary: Decrypt seed lockbox
    Beneficiary->>Beneficiary: Derive DID keys
    Beneficiary->>DID: Update DID Document with new controller
                    </div>
                </div>
            </section>

            <!-- Type C -->
            <section id="type-c">
                <h3>5.3 Type C: MPC-Mediated Recovery</h3>
                <p><strong>Type URI:</strong> <code>RecoveryMethodMPC</code></p>
                <p>The MPC-Mediated Recovery mechanism distributes key shares across multiple independent providers who perform threshold signatures without reconstructing the full key.</p>

                <h4>5.3.1 Cryptographic Requirements</h4>
                <ul>
                    <li><strong>Threshold Signatures:</strong> fROST (Flexible Round-Optimized Schnorr Threshold) signatures.</li>
                    <li><strong>Proactive Secret Sharing:</strong> Share refreshment as specified in §7.1.3.</li>
                    <li><strong>Authentication:</strong> Verifiable Credentials or WebAuthn.</li>
                    <li><strong>Transport:</strong> mTLS or Noise Protocol for secure provider communication.</li>
                </ul>

                <h4>5.3.2 Share Refreshment</h4>
                <p>Providers MUST support periodic share refreshment using the proactive refresh protocol defined in §7.1.3. After each refresh:</p>
                <ol>
                    <li>Each provider's share changes, but the secret and group public key remain identical.</li>
                    <li>Combined commitments are updated: <code>C<sub>j</sub><sup>new</sup> = C<sub>j</sub><sup>old</sup> · g<sup>r<sub>j</sub></sup> mod p</code>.</li>
                    <li>Old shares are securely deleted.</li>
                    <li>The epoch counter is incremented.</li>
                </ol>

                <h4>5.3.3 DID Document Representation</h4>
                <pre><code class="language-json">{
  "id": "did:example:123#recovery-mpc",
  "type": "RecoveryMethodMPC",
  "controller": "did:example:123",
  "mpcThreshold": 2,
  "mpcTotalProviders": 3,
  "mpcProtocol": "fROST-ed25519-2024",
  "mpcProviders": [
    {
      "id": "did:provider:one#mpc-node",
      "endpoint": "https://provider1.example.com/mpc",
      "authType": "vc-presentation"
    }
  ],
  "shareRotation": {
    "rotationInterval": "P30D",
    "currentEpoch": 42,
    "lastRotationProof": "0x8a3c...f2b5"
  }
}</code></pre>

                <div class="diagram-container">
                    <div class="diagram-title">Figure 3 — Type C: MPC Recovery with Epoch Catch-up</div>
                    <div class="mermaid">
sequenceDiagram
    participant User as User
    participant P1 as Provider 1 (Epoch 42)
    participant P2 as Provider 2 (Epoch 42)
    participant P3 as Provider 3 (Epoch 41)
    participant Coord as MPC Coordinator

    User->>P1: Authenticate
    User->>P2: Authenticate
    User->>P3: Authenticate

    P1-->>User: Auth OK (epoch=42)
    P2-->>User: Auth OK (epoch=42)
    P3-->>User: Auth OK (epoch=41)

    Note over User: Detects epoch skew on P3

    User->>P3: Request catch-up
    P3->>P1: Request refresh transcript (41→42)
    P1-->>P3: Verifiable refresh proof
    P3->>P3: Verify & update share to epoch 42
    P3-->>User: Ready (epoch=42)

    User->>Coord: Initiate MPC signing
    Coord->>P1: Signing request
    Coord->>P2: Signing request
    Coord->>P3: Signing request

    P1-->>Coord: Partial signature
    P2-->>Coord: Partial signature
    P3-->>Coord: Partial signature

    Coord->>Coord: Aggregate (threshold=2)
    Coord-->>User: Final signature
    User->>DID Method: Update DID Document
                    </div>
                </div>
            </section>

            <!-- Provider Sync -->
            <section id="provider-sync">
                <h3>5.4 Provider State Synchronization (Normative)</h3>
                <p>When providers operate at different epochs, the recovery protocol MUST handle version skew to prevent state drift from becoming a single point of failure.</p>

                <h4>5.4.1 Epoch Discovery</h4>
                <p>During recovery initiation, each provider MUST include their <code>currentEpoch</code> in the authentication response.</p>

                <h4>5.4.2 Lag Detection</h4>
                <p>The recovering party MUST compare epochs from all providers. Any provider more than <code>maxEpochSkew</code> (RECOMMENDED: 1) behind the majority MUST be excluded from the signing ceremony until caught up.</p>

                <h4>5.4.3 Automatic Catch-up Protocol</h4>
                <ol>
                    <li><strong>Catch-up Request:</strong> Lagging provider sends a signed request to an up-to-date provider specifying <code>currentEpoch</code> and <code>targetEpoch</code>.</li>
                    <li><strong>Verifiable Refresh Transcript:</strong> The responding provider returns the group public key plus a cryptographically verifiable transcript of each refresh operation between the two epochs.</li>
                    <li><strong>Verification and Update:</strong> The lagging provider verifies each transcript, updates their local share, and securely deletes the old share.</li>
                    <li><strong>Confirmation:</strong> Provider confirms readiness to the recovering party.</li>
                </ol>

                <h4>5.4.4 Synchronization Parameters</h4>
                <pre><code class="language-json">"shareRotation": {
  "rotationInterval": "P30D",
  "currentEpoch": 42,
  "providerStateEndpoint": "https://provider1.example.com/state",
  "lastRotationProof": "0x8a3c...f2b5",
  "synchronization": {
    "maxEpochSkew": 1,
    "catchupProtocol": "vss-refresh-verifiable-2025",
    "timeout": "PT30S",
    "requiredQuorum": 2
  }
}</code></pre>
            </section>
        </section>

        <!-- ── Verification Relationships ── -->
        <section id="verification-relationships">
            <h2>6. Verification Relationships</h2>

            <h3>6.1 The <code>recovery</code> Relationship</h3>
            <p>The <code>recovery</code> verification relationship indicates that the associated verification methods are specifically authorized for recovering control of the DID. These methods are limited to recovery operations and MUST NOT be used for general authentication.</p>

            <pre><code class="language-json">{
  "@context": [
    "https://www.w3.org/ns/did/v1",
    "https://sirraya.org/ns/did/recovery/v1"
  ],
  "id": "did:example:123",
  "recovery": [
    "did:example:123#recovery-social",
    "did:example:123#recovery-seedling",
    "did:example:123#recovery-mpc"
  ]
}</code></pre>

            <h3>6.2 Processing Rules</h3>
            <ol>
                <li>The resolver MUST verify that the recovery method is listed in the <code>recovery</code> relationship.</li>
                <li>The resolver MUST verify that the recovery method's <code>controller</code> is authorized to modify the DID Document.</li>
                <li>The resolver MUST perform dependency checking to prevent recovery loops (see §8.4).</li>
            </ol>
        </section>

        <!-- ── Cryptographic Primitives ── -->
        <section id="crypto-primitives">
            <h2>7. Cryptographic Primitives</h2>

            <!-- §7.0 — NEW -->
            <section id="vss-group">
                <h3>7.0 VSS Group Parameters <span class="tag-new">NEW in rev 2.1</span></h3>

                <div class="callout fixed">
                    <div class="callout-label">Correction Notice</div>
                    <p>The original specification (rev 1.x) incorrectly stated that VSS could be instantiated using the secp256k1 scalar order <em>N</em> as both the polynomial field modulus and the group modulus for commitments. This is mathematically invalid (see §7.0.1 for the full explanation) and caused share verification to fail for all participant indices ≥ 2. This section and §7.1 are normatively corrected.</p>
                </div>

                <h4>7.0.1 Why a Dedicated Group is Required</h4>
                <p>Feldman VSS verification requires the equation:</p>
                <div class="math-block">
g<sup>s<sub>i</sub></sup>  ≡  ∏<sub>j=0</sub><sup>t−1</sup>  C<sub>j</sub><sup>i<sup>j</sup></sup>  (mod p)
                </div>
                <p>For this to hold consistently, exponents on both sides must reduce modulo the same value — the order of the generator <em>g</em> in the group. This requires:</p>
                <ol>
                    <li>A scalar field of prime order <strong>q</strong> for polynomial arithmetic (shares, coefficients, Lagrange interpolation).</li>
                    <li>A group prime <strong>p</strong> with <strong>q | (p−1)</strong>, so that a subgroup of order exactly <strong>q</strong> exists in Z<sub>p</sub>*.</li>
                    <li>A generator <strong>g</strong> of order exactly <strong>q</strong> in Z<sub>p</sub>*.</li>
                </ol>
                <p>Using a single prime for both roles (as in the previous revision using secp256k1's N) breaks the consistency because <em>g</em> has order dividing N−1, not N itself, making exponent reduction mod N incorrect.</p>

                <h4>7.0.2 Mandatory Group Parameters</h4>
                <p>Implementations MUST use the following parameters, or an equivalent set verifiable by the same properties:</p>

                <div class="param-box">
                    <div class="param-row"><span class="param-key">p</span><span class="param-val">0x50179e4375e428b3af8fe52af1f2a50e5100b916d0d1c1bbedc304c3d35f3217</span></div>
                    <div class="param-row"><span class="param-key">q</span><span class="param-val">0x280bcf21baf21459d7c7f29578f9528728805c8b6868e0ddf6e18261e9af990b</span></div>
                    <div class="param-row"><span class="param-key">g</span><span class="param-val">4</span></div>
                    <div class="param-row"><span class="param-key">bits</span><span class="param-val">256-bit safe prime (p = 2q+1)</span></div>
                </div>

                <h4>7.0.3 Parameter Verification</h4>
                <p>Any implementation MUST be able to verify the following properties hold:</p>
                <div class="math-block">
isPrime(p) = True<br>
isPrime(q) = True<br>
p = 2·q + 1          <span class="math-comment">// safe prime</span><br>
pow(g, q, p) = 1     <span class="math-comment">// g has order q</span><br>
pow(g, 1, p) ≠ 1     <span class="math-comment">// g is not the identity</span>
                </div>

                <h4>7.0.4 Alternative Parameters</h4>
                <p>Implementations MAY use alternative parameters of equivalent or greater security, provided they satisfy all properties in §7.0.3 and publish the parameters in the DID Document's <code>vssGroupParameters</code> field for interoperability.</p>
            </section>

            <!-- §7.1 — UPDATED -->
            <section id="feldman-vss">
                <h3>7.1 Verifiable Secret Sharing (Feldman's VSS) <span class="tag-changed">UPDATED in rev 2.1</span></h3>

                <p>Let <code>(p, q, g)</code> be as defined in §7.0. All scalar (polynomial) operations are in <strong>Z<sub>q</sub></strong>. All commitment (group) operations are in <strong>Z<sub>p</sub></strong>.</p>

                <h4>7.1.1 Share Generation</h4>
                <ol>
                    <li>Dealer chooses secret <code>s ∈ Z<sub>q</sub></code> and random coefficients <code>a<sub>1</sub>, …, a<sub>t−1</sub> ←<sub>R</sub> Z<sub>q</sub></code>.</li>
                    <li>Forms polynomial <code>P(x) = s + a<sub>1</sub>x + … + a<sub>t−1</sub>x<sup>t−1</sup></code> over <code>Z<sub>q</sub></code>.</li>
                    <li>For participant <code>i = 1…n</code>, share <code>s<sub>i</sub> = P(i) mod q</code>.</li>
                    <li>Computes Feldman commitments: <code>C<sub>j</sub> = g<sup>a<sub>j</sub></sup> mod p</code> for <code>j = 0…t−1</code>.</li>
                </ol>

                <h4>7.1.2 Share Verification</h4>
                <p>Participant <code>i</code> verifies their share by checking (all arithmetic mod p, exponents mod q):</p>
                <div class="math-block">
g<sup>s<sub>i</sub></sup>  ≡  ∏<sub>j=0</sub><sup>t−1</sup>  C<sub>j</sub><sup>i<sup>j</sup> mod q</sup>  (mod p)
                </div>
                <p>This holds because <code>ord(g) = q</code>, so <code>g<sup>x mod q</sup> = g<sup>x</sup> mod p</code> for any integer x.</p>

                <div class="callout note">
                    <div class="callout-label">Implementation Note</div>
                    <p>Exponents <code>i<sup>j</sup></code> MUST be reduced modulo <code>q</code> (the scalar field order), NOT modulo <code>q−1</code>, <code>p−1</code>, or any other value. Reducing by the wrong modulus is the root cause of the pre-revision failure.</p>
                </div>

                <h4>7.1.3 Secret Recovery</h4>
                <p>Given <code>t</code> shares <code>{(i, s<sub>i</sub>)}</code>, recover <code>s = P(0)</code> via Lagrange interpolation in <code>Z<sub>q</sub></code>:</p>
                <div class="math-block">
s  =  ∑<sub>j</sub>  s<sub>j</sub> · L<sub>j</sub>(0)  mod q<br><br>
L<sub>j</sub>(0)  =  ∏<sub>m≠j</sub>  (0 − x<sub>m</sub>) / (x<sub>j</sub> − x<sub>m</sub>)  mod q
                </div>
                <p>Division is computed as multiplication by the modular inverse: <code>a<sup>−1</sup> mod q = a<sup>q−2</sup> mod q</code> (Fermat, since q is prime).</p>

                <h4>7.1.4 Proactive Share Refreshment</h4>
                <p>To re-randomize shares without changing the secret:</p>
                <ol>
                    <li>Generate refresh polynomial <code>R(x) = r<sub>1</sub>x + … + r<sub>t−1</sub>x<sup>t−1</sup></code> over <code>Z<sub>q</sub></code> with <code>R(0) = 0</code>.</li>
                    <li>Compute refresh shares <code>δ<sub>i</sub> = R(i) mod q</code> and refresh commitments <code>D<sub>j</sub> = g<sup>r<sub>j</sub></sup> mod p</code>.</li>
                    <li>Update each share: <code>s<sub>i</sub><sup>new</sup> = (s<sub>i</sub><sup>old</sup> + δ<sub>i</sub>) mod q</code>.</li>
                    <li>Update commitments: <code>C<sub>j</sub><sup>new</sup> = C<sub>j</sub><sup>old</sup> · D<sub>j</sub> mod p = g<sup>a<sub>j</sub> + r<sub>j</sub></sup> mod p</code>.</li>
                    <li>Secret is preserved: <code>P<sup>new</sup>(0) = P<sup>old</sup>(0) + R(0) = s + 0 = s</code>.</li>
                    <li>Verify each refreshed share against combined commitments before deleting the old share.</li>
                </ol>
            </section>

            <!-- §7.2 -->
            <section id="zkp">
                <h3>7.2 Zero-Knowledge Proof of Share</h3>
                <p>To prove knowledge of share <code>s<sub>i</sub> ∈ Z<sub>q</sub></code> without revealing it (Schnorr proof, all operations mod p/q as appropriate):</p>
                <ol>
                    <li>Prover chooses random <code>r ← Z<sub>q</sub></code>.</li>
                    <li>Prover sends <code>R = g<sup>r</sup> mod p</code>.</li>
                    <li>Verifier sends challenge <code>c ← Z<sub>q</sub></code>.</li>
                    <li>Prover sends <code>z = (r + c · s<sub>i</sub>) mod q</code>.</li>
                    <li>Verifier checks: <code>g<sup>z</sup> ≡ R · (∏ C<sub>j</sub><sup>i<sup>j</sup> mod q</sup>)<sup>c</sup> (mod p)</code>.</li>
                </ol>
            </section>

            <!-- §7.3 -->
            <section id="vdf">
                <h3>7.3 Verifiable Delay Function (Wesolowski)</h3>
                <p><strong>Input:</strong> <code>x ∈ QR(N)</code>, time parameter <code>T</code><br>
                <strong>Output:</strong> <code>y = x<sup>2<sup>T</sup></sup> mod N</code>, proof <code>π</code></p>
                <ol>
                    <li>Compute <code>y = x<sup>2<sup>T</sup></sup> mod N</code> via sequential squaring.</li>
                    <li>Let <code>l = ⌊2<sup>T</sup> / 2⌋</code>, compute <code>π = x<sup>l</sup> mod N</code>.</li>
                    <li>Verifier checks: <code>π<sup>2<sup>(T/2)</sup></sup> · x<sup>2<sup>T</sup> mod 2<sup>(T/2)</sup></sup> = y mod N</code>.</li>
                </ol>

                <h4>7.4 VDF Parameter Calibration (Normative)</h4>
                <p>Difficulty is measured in sequential squaring operations. Published parameters MUST include a <code>referencePlatform</code> and <code>tolerance</code> factor.</p>
                <pre><code class="language-json">"vdfParameters": {
  "difficulty": 1000000,
  "estimatedWallTime": "P30D",
  "referencePlatform": "intel-i9-13900k-2024",
  "tolerance": 0.2,
  "verificationMode": "wesolowski-optimistic"
}</code></pre>
            </section>

            <!-- §7.5 -->
            <section id="frost">
                <h3>7.5 fROST Threshold Signatures</h3>
                <p>fROST enables <code>t-of-n</code> threshold Schnorr signatures:</p>
                <ol>
                    <li><strong>Key Generation:</strong> Distributed key generation produces group public key and individual secret shares.</li>
                    <li><strong>Signing:</strong> Each participant generates a nonce and commitment.</li>
                    <li><strong>Aggregation:</strong> Coordinator aggregates commitments and challenges.</li>
                    <li><strong>Response:</strong> Each participant responds with partial signatures.</li>
                    <li><strong>Finalization:</strong> Coordinator aggregates partial signatures into final signature.</li>
                </ol>
            </section>
        </section>

        <!-- ── Security ── -->
        <section id="security-considerations">
            <h2>8. Security Considerations</h2>

            <h3>8.1 Guardian Collusion (Type A)</h3>
            <p><strong>Threat:</strong> A threshold of guardians collude to reconstruct the user's private key.</p>
            <p><strong>Mitigation:</strong> Feldman VSS with Pedersen commitments ensures shares are individually verifiable. Guardians SHOULD be selected from diverse trust domains, and threshold SHOULD be ≥ 3-of-5.</p>

            <h3>8.2 Time-Lock Bypass (Type B)</h3>
            <p><strong>Threat:</strong> An attacker compromises the dead man's switch to release inheritance keys prematurely.</p>
            <p><strong>Mitigation:</strong> VDFs provide computational asymmetry that cannot be parallelized, making premature release computationally infeasible within the specified time window.</p>

            <h3>8.3 Provider State Drift (Type C)</h3>
            <p><strong>Threat:</strong> MPC providers update shares independently, causing key desynchronization.</p>
            <p><strong>Mitigation:</strong> Proactive Secret Sharing with verifiable refresh transcripts (§7.1.4) ensures consistency. The catch-up protocol (§5.4.3) handles epoch lag.</p>

            <h3>8.4 Recovery-Loop Prevention</h3>
            <p><strong>Threat:</strong> Circular recovery dependencies make recovery impossible.</p>
            <p><strong>Mitigation:</strong> Implementations MUST validate that the dependency graph of recovery methods is acyclic at publication time, at recovery initiation, and during periodic health checks.</p>

            <div class="math-block">
function checkAcyclic(did, visited = new Set()):
  if visited.has(did): return false
  visited.add(did)
  for each recoveryMethod in resolve(did).recovery:
    for each guardian in recoveryMethod.guardians:
      if guardian.id is DID:
        if not checkAcyclic(guardian.id, visited):
          return false
  visited.delete(did)
  return true
            </div>

            <div class="diagram-container">
                <div class="diagram-title">Figure 4 — Recovery-Loop Detection</div>
                <div class="mermaid">
graph TD
    subgraph bad["Graph 1: Loop Detected ✗"]
        A1[did:example:123] -->|recovery| B1[did:guardian:abc]
        B1 -->|controller| A1
    end

    subgraph good["Graph 2: Valid Tree ✓"]
        A2[did:example:456] -->|recovery| C2[did:guardian:def]
        A2 -->|recovery| D2[did:guardian:ghi]
    end

    style A1 fill:#fee2e2,stroke:#ef4444,stroke-width:3px
    style B1 fill:#fee2e2,stroke:#ef4444
    style A2 fill:#dcfce7,stroke:#22c55e,stroke-width:3px
    style C2 fill:#dcfce7,stroke:#22c55e
    style D2 fill:#dcfce7,stroke:#22c55e
                </div>
            </div>

            <h3>8.5 Key Wrapping Security</h3>
            <p><strong>Threat:</strong> Weak encryption of seed lockboxes.</p>
            <p><strong>Mitigation:</strong> All encrypted payloads MUST use AEAD with ≥ 256-bit keys. XChaCha20-Poly1305 or AES-256-GCM are REQUIRED. The algorithm MUST be explicitly named in the DID Document.</p>

            <h3>8.6 Quantum Computing Resistance</h3>
            <p>Current algorithms are secure against classical computers. Implementations SHOULD plan transition paths:</p>
            <ul>
                <li><strong>Type A:</strong> Consider lattice-based VSS for post-quantum security.</li>
                <li><strong>Type B:</strong> Use hash-based signatures for seed commitment.</li>
                <li><strong>Type C:</strong> Transition to threshold lattice signatures when standardized.</li>
            </ul>
        </section>

        <!-- ── Privacy ── -->
        <section id="privacy-considerations">
            <h2>9. Privacy Considerations</h2>

            <h3>9.1 Metadata Leakage</h3>
            <p>Recovery methods may expose social graph (guardian identities), security posture (threshold values), and activity patterns. Mitigations include encrypted DID Document entries, guardian anonymity via onion services, and minimum-disclosure design.</p>

            <h3>9.2 Guardian Privacy</h3>
            <p>Instead of full DIDs, implementations SHOULD publish salted hashes:</p>
            <pre><code class="language-json">"recoveryGuardians": [
  {
    "id": "urn:hash:sha256:3a7b...c9f2",
    "salt": "0x4d8e...f2a3",
    "guardianEndpoint": "http://guardian1.onion/recover",
    "commitmentIndex": 0
  }
]</code></pre>

            <h3>9.3 Correlation Risk</h3>
            <p>The same recovery method across multiple DIDs could correlate them. DID controllers SHOULD use different guardian sets, salt values, and encryption keys per DID.</p>

            <h3>9.4 Beneficiary Privacy</h3>
            <p>Beneficiaries SHOULD use single-use derived keys specific to each inheritance relationship, not linked to their primary identity.</p>
        </section>

        <!-- ── Interoperability ── -->
        <section id="interoperability">
            <h2>10. Interoperability Requirements</h2>

            <h3>10.1 Mandatory-to-Implement Algorithms</h3>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Algorithm</th><th>Usage</th></tr></thead>
                    <tbody>
                        <tr><td>Ed25519</td><td>Signatures, guardian keys</td></tr>
                        <tr><td>SHA-256</td><td>Hashing</td></tr>
                        <tr><td>XChaCha20-Poly1305</td><td>Seed lockbox encryption</td></tr>
                        <tr><td>AES-256-GCM</td><td>Share encryption at rest</td></tr>
                        <tr><td>BIP-32</td><td>Key derivation</td></tr>
                        <tr><td>fROST (Ed25519)</td><td>Threshold signatures</td></tr>
                        <tr><td>Feldman VSS (p,q,g per §7.0)</td><td>Verifiable secret sharing</td></tr>
                        <tr><td>Wesolowski VDF</td><td>Time-locks</td></tr>
                        <tr><td>PBKDF2-SHA256 (100k iter)</td><td>Seed derivation</td></tr>
                    </tbody>
                </table>
            </div>

            <h3>10.2 Optional Algorithms</h3>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Algorithm</th><th>Usage</th></tr></thead>
                    <tbody>
                        <tr><td>secp256k1</td><td>Blockchain compatibility</td></tr>
                        <tr><td>BLS12-381</td><td>Pairing-based cryptography</td></tr>
                        <tr><td>Pietrzak VDF</td><td>Alternative time-locks</td></tr>
                        <tr><td>Dilithium</td><td>Post-quantum signatures</td></tr>
                        <tr><td>Kyber</td><td>Post-quantum encryption</td></tr>
                    </tbody>
                </table>
            </div>

            <h3>10.3 DID Method Compatibility</h3>
            <p>This specification is DID method agnostic but requires methods that support DID Document updates, resolution for recovery method discovery, and deactivation of compromised recovery methods.</p>
        </section>

        <!-- ── JSON-LD ── -->
        <section id="json-ld-context">
            <h2>11. JSON-LD Context</h2>
            <p>Available at: <code>https://sirraya.org/ns/did/recovery/v1.jsonld</code></p>
            <pre><code class="language-json">{
  "@context": {
    "@version": 1.1,
    "@protected": true,

    "id": "@id",
    "type": "@type",

    "RecoveryMethod": "https://sirraya.org/ns/did/recovery#RecoveryMethod",
    "RecoveryMethodZKPSocial": "https://sirraya.org/ns/did/recovery#RecoveryMethodZKPSocial",
    "RecoveryMethodDeterministic": "https://sirraya.org/ns/did/recovery#RecoveryMethodDeterministic",
    "RecoveryMethodMPC": "https://sirraya.org/ns/did/recovery#RecoveryMethodMPC",

    "recovery": {
      "@id": "https://sirraya.org/ns/did/recovery#recovery",
      "@type": "@id",
      "@container": "@set"
    },
    "recoveryThreshold": {
      "@id": "https://sirraya.org/ns/did/recovery#recoveryThreshold",
      "@type": "xsd:integer"
    },
    "vssGroupParameters": {
      "@id": "https://sirraya.org/ns/did/recovery#vssGroupParameters",
      "@type": "@id"
    },
    "vssScheme": {
      "@id": "https://sirraya.org/ns/did/recovery#vssScheme",
      "@type": "xsd:string"
    },
    "recoveryGuardians": {
      "@id": "https://sirraya.org/ns/did/recovery#recoveryGuardians",
      "@type": "@id",
      "@container": "@set"
    },
    "guardianEndpoint": {
      "@id": "https://sirraya.org/ns/did/recovery#guardianEndpoint",
      "@type": "xsd:anyURI"
    },
    "vssCommitments": {
      "@id": "https://sirraya.org/ns/did/recovery#vssCommitments",
      "@type": "xsd:string",
      "@container": "@list"
    },
    "seedDerivationPath": {
      "@id": "https://sirraya.org/ns/did/recovery#seedDerivationPath",
      "@type": "xsd:string"
    },
    "encryptedSeedLockbox": {
      "@id": "https://sirraya.org/ns/did/recovery#encryptedSeedLockbox",
      "@type": "@id"
    },
    "deadMansSwitch": {
      "@id": "https://sirraya.org/ns/did/recovery#deadMansSwitch",
      "@type": "@id"
    },
    "vdfParameters": {
      "@id": "https://sirraya.org/ns/did/recovery#vdfParameters",
      "@type": "@id"
    },
    "mpcThreshold": {
      "@id": "https://sirraya.org/ns/did/recovery#mpcThreshold",
      "@type": "xsd:integer"
    },
    "mpcProviders": {
      "@id": "https://sirraya.org/ns/did/recovery#mpcProviders",
      "@type": "@id",
      "@container": "@set"
    },
    "shareRotation": {
      "@id": "https://sirraya.org/ns/did/recovery#shareRotation",
      "@type": "@id"
    },
    "currentEpoch": {
      "@id": "https://sirraya.org/ns/did/recovery#currentEpoch",
      "@type": "xsd:integer"
    },
    "synchronization": {
      "@id": "https://sirraya.org/ns/did/recovery#synchronization",
      "@type": "@id"
    },
    "maxEpochSkew": {
      "@id": "https://sirraya.org/ns/did/recovery#maxEpochSkew",
      "@type": "xsd:integer"
    },
    "catchupProtocol": {
      "@id": "https://sirraya.org/ns/did/recovery#catchupProtocol",
      "@type": "xsd:string"
    }
  }
}</code></pre>
        </section>

        <!-- ── Protocol Flows ── -->
        <section id="protocol-flows">
            <h2>12. Recovery Protocol Flows</h2>

            <h3>12.1 Type A Recovery Protocol</h3>
            <p><strong>Request:</strong></p>
            <pre><code class="language-http">POST /recover HTTP/1.1
Host: guardian1.example.com
Content-Type: application/json

{
  "protocol": "did-kr-recovery-v1",
  "recoveryId": "did:example:123#recovery-social",
  "did": "did:example:123",
  "nonce": "a1b2c3d4e5f6...",
  "challenge": "0x4d5e6f7a8b9c...",
  "commitmentIndex": 0
}</code></pre>
            <p><strong>Response:</strong></p>
            <pre><code class="language-json">{
  "status": "success",
  "proof": {
    "type": "schnorr-proof-2025",
    "commitment": "0x8f3a2b1c...",
    "challenge": "0x4d5e6f7a...",
    "response": "0x2b7c8d9e..."
  },
  "guardianId": "did:guardian:abc#key-1",
  "signature": "0x9a8b7c6d..."
}</code></pre>

            <h3>12.2 Type B Recovery Protocol</h3>
            <p><strong>Self-recovery:</strong></p>
            <pre><code class="language-http">POST /recover/seed HTTP/1.1
Host: wallet.example.com
Content-Type: application/json

{
  "protocol": "did-kr-recovery-v1",
  "recoveryId": "did:example:123#recovery-seedling",
  "seedPhrase": "abandon ability able about above ...",
  "derivationPath": "m/44'/0'/0'/0/0"
}</code></pre>

            <h3>12.3 Type C Recovery Protocol</h3>
            <p><strong>Phase 1: Authentication Response</strong></p>
            <pre><code class="language-json">{
  "status": "authenticated",
  "provider": "did:provider:one#mpc-node",
  "currentEpoch": 42,
  "lastRotation": "2024-05-15T10:30:00Z",
  "signature": "0x9a8b7c6d..."
}</code></pre>
            <p><strong>Phase 2: MPC Signing Ceremony</strong></p>
            <pre><code class="language-http">POST /mpc/sign HTTP/1.1
Host: provider1.example.com
Content-Type: application/json

{
  "protocol": "did-kr-recovery-v1",
  "sessionId": "sess_abc123def456",
  "operation": {
    "type": "update-did",
    "newDocument": { "id": "did:example:123", "..." : "..." }
  },
  "commitment": "0x3e4f5a6b..."
}</code></pre>
        </section>

        <!-- ── Test Vectors ── -->
        <section id="test-vectors">
            <h2>13. Test Vectors <span class="tag-changed">UPDATED in rev 2.1</span></h2>

            <div class="callout fixed">
                <div class="callout-label">Test Vectors Corrected</div>
                <p>Previous test vectors used incorrect field parameters. All vectors below are computed with the group (p, q, g) defined in §7.0 and have been machine-verified against the reference implementation.</p>
            </div>

            <h3>13.1 Type A Test Vector — Feldman VSS</h3>
            <p><strong>Group parameters:</strong> (p, q, g) as in §7.0.</p>
            <p><strong>Setup:</strong></p>
            <ul>
                <li>Secret: <code>s = 42</code> (as a scalar in Z<sub>q</sub>)</li>
                <li>Threshold: <code>t = 2</code></li>
                <li>Total shares: <code>n = 3</code></li>
                <li>Polynomial: <code>P(x) = 42 + 17·x</code> (over Z<sub>q</sub>)</li>
            </ul>
            <p><strong>Shares</strong> (computed as <code>P(i) mod q</code>):</p>
            <div class="math-block">
s₁ = P(1) mod q = 59<br>
s₂ = P(2) mod q = 76<br>
s₃ = P(3) mod q = 93
            </div>
            <p><strong>Commitments</strong> (computed as <code>g<sup>a<sub>j</sub></sup> mod p</code>):</p>
            <div class="math-block">
C₀ = 4<sup>42</sup> mod p<br>
C₁ = 4<sup>17</sup> mod p
            </div>
            <p><strong>Share verification example</strong> for <code>s₃</code> (x=3):</p>
            <div class="math-block">
LHS = 4<sup>93</sup> mod p<br>
RHS = C₀<sup>1</sup> · C₁<sup>3 mod q</sup> mod p  =  4<sup>42</sup> · 4<sup>17·3</sup> mod p  =  4<sup>42+51</sup> mod p  =  4<sup>93</sup> mod p  ✓
            </div>
            <p><strong>Recovery with shares s₁, s₂</strong> (Lagrange in Z<sub>q</sub>):</p>
            <div class="math-block">
L₁(0) = (0−2)/(1−2) mod q = (−2)·(−1)⁻¹ mod q = 2<br>
L₂(0) = (0−1)/(2−1) mod q = (−1)·(1)⁻¹ mod q = q−1<br>
s = 59·2 + 76·(q−1) mod q = 118 − 76 mod q = 42  ✓
            </div>

            <h3>13.2 Type A Test Vector — Proactive Refresh</h3>
            <p><strong>Continuing from §13.1</strong> — applying a refresh polynomial <code>R(x) = 5·x</code> (R(0)=0):</p>
            <div class="math-block">
δ₁ = R(1) = 5,  δ₂ = R(2) = 10,  δ₃ = R(3) = 15<br><br>
s₁ᶰᵉʷ = (59 + 5) mod q  = 64<br>
s₂ᶰᵉʷ = (76 + 10) mod q = 86<br>
s₃ᶰᵉʷ = (93 + 15) mod q = 108<br><br>
C₀ᶰᵉʷ = C₀ · g⁰ mod p  = C₀          (r₀ = 0, constant term is always 0)<br>
C₁ᶰᵉʷ = C₁ · 4⁵ mod p  = 4¹⁷ · 4⁵ mod p = 4²² mod p<br><br>
Recovery with s₁ᶰᵉʷ, s₂ᶰᵉʷ:  s = 64·2 + 86·(q−1) mod q = 128 − 86 = 42  ✓
            </div>

            <h3>13.3 Type B Test Vector</h3>
            <p><strong>Master Seed:</strong> <code>0x7f3a9b8c2d5e1f4a3b6c7d8e9f0a1b2c</code></p>
            <p><strong>Derivation Path:</strong> <code>m/44'/0'/0'/0/0</code></p>
            <p><strong>PBKDF2 salt:</strong> <code>"did-kr-salt:did:example:123"</code> (UTF-8), 100,000 iterations</p>
            <p><strong>Derived Private Key:</strong> <code>SHA-256(PBKDF2(seed, salt, 100000, 32))</code></p>

            <h3>13.4 Type C Test Vector</h3>
            <p><strong>fROST t=2, n=3</strong> — share format (illustrative, not actual key material):</p>
            <pre><code>Group Public Key: 0x3a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d...
Share 1 (epoch 1): 0x8c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f...
Share 2 (epoch 1): 0x2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e...
Share 3 (epoch 1): 0x7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c...</code></pre>
        </section>

        <!-- ── References ── -->
        <section id="references">
            <h2>14. References</h2>

            <h3>14.1 Normative References</h3>
            <dl>
                <dt>[DID-CORE]</dt><dd>Decentralized Identifier Specification v1.0</dd>
                <dt>[RFC2119]</dt><dd>Key words for use in RFCs</dd>
                <dt>[RFC8174]</dt><dd>Ambiguity of Uppercase vs Lowercase in RFC2119</dd>
                <dt>[BIP32]</dt><dd>Hierarchical Deterministic Wallets</dd>
                <dt>[BIP39]</dt><dd>Mnemonic code for generating deterministic keys</dd>
                <dt>[FROST]</dt><dd>Flexible Round-Optimized Schnorr Threshold Signatures</dd>
                <dt>[VDF]</dt><dd>Verifiable Delay Functions — Boneh et al., 2018</dd>
                <dt>[FELDMAN]</dt><dd>Feldman's Verifiable Secret Sharing — Feldman, 1987</dd>
                <dt>[SAFE-PRIME]</dt><dd>Safe prime group parameter generation — NIST SP 800-57</dd>
            </dl>

            <h3>14.2 Informative References</h3>
            <dl>
                <dt>[SOCIAL-RECOVERY]</dt><dd>Social Key Recovery for Self-Sovereign Identity</dd>
                <dt>[MPC-WALLET]</dt><dd>Threshold Signatures for Cryptographic Wallets</dd>
                <dt>[TIME-LOCK]</dt><dd>Time-Lock Encryption with Verifiable Delay Functions</dd>
                <dt>[ZKP-AUTH]</dt><dd>Zero-Knowledge Proofs for Authentication</dd>
                <dt>[PROACTIVE]</dt><dd>Proactive Secret Sharing — Herzberg et al., 1995</dd>
            </dl>
        </section>

        <!-- ── Acknowledgements ── -->
        <section id="acknowledgements">
            <h2>15. Acknowledgements</h2>
            <p>The editor would like to thank the members of the decentralized identity community for their valuable feedback and contributions. Special thanks to the cryptographic reviewers who identified the VSS group parameter error in revision 1.x, the privacy researchers who contributed to the guardian privacy enhancements, and the implementers who caught the share verification failure during integration testing.</p>
        </section>

        <!-- ── Appendices ── -->
        <section id="appendices">
            <h2>Appendices</h2>

            <h3>Appendix A: Implementation Checklist</h3>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr><th>Requirement</th><th>Status</th><th>Notes</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Type A: VSS group parameters (§7.0)</td>
                            <td><span class="badge badge-done">✓ Complete</span></td>
                            <td>256-bit safe prime (p, q, g); verified in reference impl v2.1</td>
                        </tr>
                        <tr>
                            <td>Type A: VSS share generation &amp; verification (§7.1)</td>
                            <td><span class="badge badge-done">✓ Complete</span></td>
                            <td>Feldman VSS; all-indices self-check passes; proactive refresh verified</td>
                        </tr>
                        <tr>
                            <td>Type A: ZKP implementation (§7.2)</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>Schnorr proofs of share knowledge</td>
                        </tr>
                        <tr>
                            <td>Type A: Guardian privacy (§9.2)</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>Hashed guardian identifiers</td>
                        </tr>
                        <tr>
                            <td>Type A: Social recovery (reconstruct + re-key)</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>Guardian HTTP endpoints; share delivery protocol</td>
                        </tr>
                        <tr>
                            <td>Type B: HD key derivation (§5.2)</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>BIP-32 compatible</td>
                        </tr>
                        <tr>
                            <td>Type B: VDF implementation (§7.3)</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>Wesolowski or Pietrzak</td>
                        </tr>
                        <tr>
                            <td>Type C: fROST implementation (§7.5)</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>Threshold signatures</td>
                        </tr>
                        <tr>
                            <td>Type C: Share refreshment (§7.1.4)</td>
                            <td><span class="badge badge-done">✓ Complete</span></td>
                            <td>Proactive refresh with combined commitments; multi-epoch tested</td>
                        </tr>
                        <tr>
                            <td>Type C: Epoch synchronization (§5.4)</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>Catch-up protocol; verifiable refresh transcripts</td>
                        </tr>
                        <tr>
                            <td>Recovery-loop detection (§8.4)</td>
                            <td><span class="badge badge-done">✓ Complete</span></td>
                            <td>DFS acyclicity check; <code>validate_recovery_graph()</code></td>
                        </tr>
                        <tr>
                            <td>Ephemeral key persistence fix</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>DB encryption key regenerated on restart; KMS integration needed</td>
                        </tr>
                        <tr>
                            <td>API authentication (§12)</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>Flask endpoints open; JWT / API key middleware required</td>
                        </tr>
                        <tr>
                            <td>JSON-LD context (§11)</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>Schema updated for vssGroupParameters; publication pending</td>
                        </tr>
                        <tr>
                            <td>Test vectors (§13)</td>
                            <td><span class="badge badge-done">✓ Complete</span></td>
                            <td>VSS, refresh, and recovery vectors machine-verified in rev 2.1</td>
                        </tr>
                        <tr>
                            <td>Security review</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>External audit pending</td>
                        </tr>
                        <tr>
                            <td>Privacy review</td>
                            <td><span class="badge badge-todo">☐ Open</span></td>
                            <td>Social graph analysis pending</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Appendix B: Changelog</h3>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Revision</th><th>Section</th><th>Change</th></tr></thead>
                    <tbody>
                        <tr>
                            <td><code>rev 2.1</code></td>
                            <td>§7.0 (new)</td>
                            <td>Defines mandatory VSS group parameters (p, q, g) — 256-bit safe prime, replacing broken secp256k1 reuse.</td>
                        </tr>
                        <tr>
                            <td><code>rev 2.1</code></td>
                            <td>§7.1</td>
                            <td>Corrected Feldman VSS: scalar arithmetic in Z<sub>q</sub>, commitments in Z<sub>p</sub>, exponents reduced mod q (not mod p−1 or N).</td>
                        </tr>
                        <tr>
                            <td><code>rev 2.1</code></td>
                            <td>§7.1.4</td>
                            <td>Added normative Proactive Share Refreshment specification with combined commitment equation.</td>
                        </tr>
                        <tr>
                            <td><code>rev 2.1</code></td>
                            <td>§13</td>
                            <td>Replaced all Type A test vectors with mathematically correct values; added refresh vector (§13.2).</td>
                        </tr>
                        <tr>
                            <td><code>rev 2.1</code></td>
                            <td>§5.1.4</td>
                            <td>DID Document representation updated to include <code>vssGroupParameters</code> and <code>vssScheme</code> fields.</td>
                        </tr>
                        <tr>
                            <td><code>rev 2.1</code></td>
                            <td>§11</td>
                            <td>JSON-LD context updated with <code>vssGroupParameters</code> and <code>vssScheme</code> terms.</td>
                        </tr>
                        <tr>
                            <td><code>rev 2.1</code></td>
                            <td>Appendix A</td>
                            <td>VSS generation/verification and share refresh marked complete. Ephemeral key persistence and API auth added as open items.</td>
                        </tr>
                        <tr>
                            <td><code>rev 1.x</code></td>
                            <td>All</td>
                            <td>Initial draft. VSS group parameters incorrectly specified (secp256k1 N reused as both scalar field and group modulus).</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ── Footer ── -->
        <div class="spec-footer">
            <p>© 2026 Sirraya Labs. Licensed under the MIT License.</p>
            <p style="margin-top:0.4rem;">Editor: Amir Hameed Mir · <a href="mailto:amir@sirraya.org">amir@sirraya.org</a> · <a href="https://github.com/sirraya-labs/did-kr">GitHub</a> · <a href="https://sirraya.org">sirraya.org</a></p>
        </div>

    </main>
</div>

<script>
    mermaid.initialize({
        startOnLoad: true,
        theme: 'neutral',
        sequence: { actorMargin: 60, height: 45, showSequenceNumbers: false },
        flowchart: { useMaxWidth: true, curve: 'basis' }
    });
    hljs.highlightAll();

    // Active TOC link on scroll
    const sections = document.querySelectorAll('section[id], div.spec-header');
    const links = document.querySelectorAll('.toc-list a');
    const observer = new IntersectionObserver(entries => {
        entries.forEach(e => {
            if (e.isIntersecting) {
                links.forEach(l => l.classList.remove('active'));
                const active = document.querySelector(`.toc-list a[href="#${e.target.id}"]`);
                if (active) active.classList.add('active');
            }
        });
    }, { rootMargin: '-20% 0px -70% 0px' });
    sections.forEach(s => observer.observe(s));
</script>
</body>
</html>